# Prompt: Solutions Architect - API Endpoint Design

**Persona:** Solutions Architect
**Phase:** 1 - Planning and Design (Specialized)
**Purpose:** Design REST API endpoints with OpenAPI 3.0 specification

---

## When to Use This Prompt

✅ **Use when:**
- Your feature requires new API endpoints
- You want to validate API design before implementation
- You need to generate API documentation
- The API is complex and needs focused design

❌ **Don't use when:**
- The tech spec already has sufficient API details
- The feature doesn't have an API component
- You're just adding a field to an existing endpoint

---

## The Prompt Template

```markdown
You are a Solutions Architect designing a REST API. Based on the attached tech spec, generate an OpenAPI 3.0 specification.

**Rules:**
1. Adhere to all standards in `CONSTITUTION.md`
2. The output must be a single, valid **OpenAPI 3.0 YAML** file
3. For each endpoint, you MUST define:
   - The HTTP method (GET, POST, PUT, PATCH, DELETE)
   - The path (including path parameters)
   - All request parameters (path, query, header)
   - The request body schema (for POST/PUT/PATCH)
   - The response schema for SUCCESS cases (200, 201, 204)
   - The response schema for ERROR cases (400, 401, 403, 404, 500)
   - Authentication requirements
4. Follow REST best practices:
   - Use proper HTTP methods (GET for read, POST for create, etc.)
   - Use plural nouns for resources (e.g., `/users`, not `/user`)
   - Use path parameters for IDs (e.g., `/users/{id}`)
   - Use query parameters for filtering/sorting
   - Return appropriate status codes
5. Follow error response format from `CONSTITUTION.md`

**Endpoints to Define:**
[List the endpoints from your tech spec]

Example:
* POST /api/auth/password-reset/request - Request a password reset
* GET /api/auth/password-reset/verify - Verify a reset token
* POST /api/auth/password-reset/confirm - Confirm password reset

**Output Format:**
- Single OpenAPI 3.0 YAML file
- File name: `docs/[feature-name]-api.yaml`
- Include example requests and responses

---

**Files to Attach:**
- `[feature-name]-tech-spec.md`
- `CONSTITUTION.md`
- `docs/existing-api.yaml` (if you have existing API, for consistency)
```

---

## How to Use This Prompt

### Step 1: List Your Endpoints

From your tech spec, identify all API endpoints needed. For each, note:
- HTTP method
- Path
- Purpose

### Step 2: Specify Request/Response Formats

Tell the architect:
- [ ] What data goes in requests?
- [ ] What data comes back in responses?
- [ ] What errors can occur?

### Step 3: Define Authentication

Specify:
- [ ] Does this endpoint require authentication?
- [ ] What type? (Bearer token, API key, etc.)

### Step 4: Invoke the AI

Paste the filled prompt with attached files.

### Step 5: Review the OpenAPI Spec

Check for:
- [ ] Correct HTTP methods (GET for read, POST for create, etc.)
- [ ] Appropriate status codes
- [ ] Complete request/response schemas
- [ ] Error responses defined
- [ ] Authentication specified
- [ ] Follows REST conventions

### Step 6: Validate the YAML

- [ ] Copy the generated YAML
- [ ] Validate it: https://editor.swagger.io/
- [ ] Fix any validation errors

---

## Example Input

```markdown
**Endpoints to Define:**
* POST /api/auth/password-reset/request - Request a password reset email
* GET /api/auth/password-reset/verify - Verify if a reset token is valid
* POST /api/auth/password-reset/confirm - Complete the password reset

**Authentication:**
- All endpoints are public (no auth required for password reset)

**Error Format (from CONSTITUTION.md):**
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "User-friendly message"
  }
}
```
```

---

## Example Output (What the Architect Should Generate)

```yaml
openapi: 3.0.3
info:
  title: Password Reset API
  description: Secure password reset functionality for internal users
  version: 1.0.0
  contact:
    email: dev-team@company.com

servers:
  - url: https://api.company.com/v1
    description: Production
  - url: http://localhost:8000
    description: Local development

tags:
  - name: Password Reset
    description: Password reset operations

paths:
  /api/auth/password-reset/request:
    post:
      tags:
        - Password Reset
      summary: Request a password reset
      description: |
        Sends a password reset email to the user if the email exists in the system.
        Always returns 200 to prevent email enumeration attacks.
      operationId: requestPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@company.com
                  description: User's email address
      responses:
        '200':
          description: Success (sent even if email doesn't exist)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If that email exists, a reset link has been sent
        '400':
          description: Bad request (invalid email format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: INVALID_EMAIL
                  message: Invalid email format
        '429':
          description: Too many requests (rate limit exceeded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error:
                  code: RATE_LIMIT_EXCEEDED
                  message: Too many reset requests. Please try again in 1 hour.
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/password-reset/verify:
    get:
      tags:
        - Password Reset
      summary: Verify a password reset token
      description: Checks if a reset token is valid and not expired
      operationId: verifyResetToken
      parameters:
        - name: token
          in: query
          required: true
          description: The reset token from the email
          schema:
            type: string
            example: abc123def456ghi789
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  email:
                    type: string
                    example: u***@company.com
                    description: Masked email for security
              example:
                valid: true
                email: u***@company.com
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                expired:
                  value:
                    error:
                      code: TOKEN_EXPIRED
                      message: This reset link has expired. Please request a new one.
                invalid:
                  value:
                    error:
                      code: INVALID_TOKEN
                      message: This reset link is invalid.
                used:
                  value:
                    error:
                      code: TOKEN_ALREADY_USED
                      message: This reset link has already been used.

  /api/auth/password-reset/confirm:
    post:
      tags:
        - Password Reset
      summary: Complete the password reset
      description: |
        Resets the user's password using a valid token.
        Invalidates all existing user sessions.
      operationId: confirmPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - new_password
              properties:
                token:
                  type: string
                  example: abc123def456ghi789
                  description: The reset token from the email
                new_password:
                  type: string
                  format: password
                  minLength: 12
                  example: SecurePass123!@#
                  description: |
                    New password. Must meet complexity requirements:
                    - Minimum 12 characters
                    - At least one uppercase letter
                    - At least one lowercase letter
                    - At least one number
                    - At least one special character
      responses:
        '200':
          description: Password successfully reset
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password successfully reset
              example:
                message: Password successfully reset
        '400':
          description: Bad request (invalid token or weak password)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                weakPassword:
                  value:
                    error:
                      code: WEAK_PASSWORD
                      message: Password does not meet complexity requirements
                invalidToken:
                  value:
                    error:
                      code: INVALID_TOKEN
                      message: This reset link is invalid or expired
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: INVALID_TOKEN
            message:
              type: string
              description: Human-readable error message
              example: This reset link is invalid

  securitySchemes:
    # Note: Password reset endpoints are public (no auth required)
    # but here's the scheme for other endpoints in the system
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

# No global security required for password reset endpoints
# Other endpoints in the system would use:
# security:
#   - BearerAuth: []
```

---

## REST API Best Practices

### HTTP Methods
- **GET:** Retrieve a resource (idempotent, no side effects)
- **POST:** Create a new resource
- **PUT:** Replace an entire resource (full update)
- **PATCH:** Partially update a resource
- **DELETE:** Remove a resource

### Status Codes
- **200 OK:** Successful GET, PUT, PATCH, DELETE
- **201 Created:** Successful POST (resource created)
- **204 No Content:** Successful DELETE (no response body)
- **400 Bad Request:** Invalid input/validation error
- **401 Unauthorized:** Authentication required
- **403 Forbidden:** Authenticated but not authorized
- **404 Not Found:** Resource doesn't exist
- **429 Too Many Requests:** Rate limit exceeded
- **500 Internal Server Error:** Server error

### Naming Conventions
- Use plural nouns: `/users`, not `/user`
- Use kebab-case for multi-word resources: `/password-reset`, not `/passwordReset`
- Use path parameters for IDs: `/users/{id}`, not `/users?id=123`
- Use query parameters for filtering: `/users?status=active&limit=10`

### Versioning
- Version your API: `/api/v1/users`
- Or use headers: `Accept: application/vnd.company.v1+json`

---

## Tips for Better API Designs

### ✅ DO:
- Define all possible error responses
- Include request/response examples
- Use consistent error format (per CONSTITUTION.md)
- Document authentication requirements
- Use appropriate HTTP status codes
- Validate input (email format, string length, etc.)
- Add descriptions to all fields

### ❌ DON'T:
- Use verbs in URLs (`/getUser` → `/users/{id}`)
- Return 200 for errors
- Expose internal error details to users
- Use GET for operations with side effects
- Ignore authentication/authorization
- Forget to document error cases

---

## Common API Patterns

### Pattern 1: Pagination
```yaml
parameters:
  - name: page
    in: query
    schema:
      type: integer
      default: 1
  - name: limit
    in: query
    schema:
      type: integer
      default: 20
      maximum: 100

responses:
  '200':
    content:
      application/json:
        schema:
          type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/User'
            pagination:
              type: object
              properties:
                page:
                  type: integer
                limit:
                  type: integer
                total:
                  type: integer
                total_pages:
                  type: integer
```

### Pattern 2: Filtering & Sorting
```yaml
parameters:
  - name: status
    in: query
    schema:
      type: string
      enum: [active, inactive, pending]
  - name: sort
    in: query
    schema:
      type: string
      example: created_at:desc
```

### Pattern 3: Authentication Header
```yaml
security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

---

## Testing Your API Design

After generation:

1. **Validate the YAML:**
   - Go to https://editor.swagger.io/
   - Paste your YAML
   - Fix any errors

2. **Generate Mock Server:**
   ```bash
   # Using Prism
   npm install -g @stoplight/prism-cli
   prism mock docs/password-reset-api.yaml
   ```

3. **Test with curl:**
   ```bash
   curl -X POST http://localhost:4010/api/auth/password-reset/request \
     -H "Content-Type: application/json" \
     -d '{"email": "test@company.com"}'
   ```

---

## Next Steps After API Design Approval

1. **Save the OpenAPI spec** to `docs/[feature-name]-api.yaml`
2. **Generate client SDKs** (optional):
   ```bash
   openapi-generator-cli generate -i api.yaml -g typescript-fetch -o ./client
   ```
3. **Generate API documentation** (optional):
   - Use Swagger UI, Redoc, or similar
4. **Continue with implementation** (Phase 2)

---

## Related Resources

- [Solutions Architect Persona](../../personas/02-solutions-architect.md)
- [OpenAPI 3.0 Specification](https://swagger.io/specification/)
- [Swagger Editor](https://editor.swagger.io/)
- [REST API Design Best Practices](https://restfulapi.net/)
- Previous: [Database Schema](./1.3-architect-database-schema.md)
- Next: [Generate Task List](../phase-2-implementation/2.1-generate-task-list.md)
