# Prompt: Solutions Architect - Database Schema Design

**Persona:** Solutions Architect
**Phase:** 1 - Planning and Design (Specialized)
**Purpose:** Design a complete, production-ready database schema

---

## When to Use This Prompt

✅ **Use when:** Tech spec requires new tables, data model is complex, need validation before implementation
❌ **Don't use when:** Tech spec has sufficient database details, or just adding a column to existing table

---

## The Prompt Template

```markdown
You are a Senior Database Architect. Design the database schema for the feature in `docs/[FEATURE_NAME]-tech-spec.md`.

**Business Context:**
[Describe the domain/problem this database will support]

**High-Level Entities:**
[List main entities and key fields]

Example:
* **User:** [id, email, name, created_at]
* **Project:** [id, user_id, title, description]
* **Task:** [id, project_id, title, status]

**Rules & Constraints:**
1. This is for [PROJECT_TYPE] - do not over-engineer
2. Use **[DATABASE]** syntax (from CONSTITUTION.md)
3. Use **UUIDs** for primary keys (or specify ID strategy)
4. **Do not create additional entities** beyond those listed
5. Ensure all foreign key relationships defined
6. Create indexes for:
   - All foreign keys
   - Commonly queried fields: [LIST_FIELDS]
7. Add appropriate constraints (NOT NULL, UNIQUE, CHECK)
8. Follow naming conventions from CONSTITUTION.md

**Your Task:**
Generate complete, production-ready SQL:

1. **Table Schemas**
   - Include `DROP TABLE IF EXISTS` (for repeatability)
   - All columns with types
   - All constraints (PK, FK, UNIQUE, NOT NULL, CHECK)
   - Comments explaining decisions

2. **Indexes**
   - On foreign keys
   - On commonly queried columns

3. **Sample Test Data**
   - 3 rows per table
   - Linked foreign keys

**Output Format:**
- Single SQL file
- Well-commented
- Runnable as-is

---

**Files to Read:**
- `docs/[FEATURE_NAME]-tech-spec.md`
- `CONSTITUTION.md`
- Existing database schema files
```

---

## Quick Start Guide

### Step 1: Define Entities
List tables needed with key fields:
```
* User: id, email, password_hash, created_at
* PasswordResetToken: id, user_id, token_hash, expires_at
```

### Step 2: Describe Context
```
"This supports password reset for internal users"
"Tokens expire after 1 hour and are single-use"
```

### Step 3: Fill Template Variables
- Replace `[FEATURE_NAME]` → "password-reset"
- Replace `[PROJECT_TYPE]` → "Internal Tool"
- Replace `[DATABASE]` → "PostgreSQL"
- Replace `[LIST_FIELDS]` → "users.email, tokens.token_hash"

### Step 4: Review Schema

Check:
- [ ] Correct data types
- [ ] All foreign keys defined
- [ ] Indexes on right columns
- [ ] Appropriate constraints
- [ ] Follows naming conventions
- [ ] Not over/under-normalized

### Step 5: Test SQL
```bash
# Run in test database
psql -d test_db -f generated_schema.sql

# Verify structure
\d+ users
\d+ password_reset_tokens
```

---

## Common Patterns

### Always Include Timestamps
```sql
created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
```

### Enum with CHECK Constraint
```sql
status VARCHAR(20) NOT NULL DEFAULT 'pending',
CONSTRAINT status_valid CHECK (status IN ('pending', 'active', 'completed'))
```

### Soft Delete
```sql
deleted_at TIMESTAMP NULL
```

---

## Template Variables Reference

| Variable | Filled By | Example |
|----------|-----------|---------|
| `[FEATURE_NAME]` | Human at use-time | "password-reset" |
| `[PROJECT_TYPE]` | AI (from CONSTITUTION.md) | "Internal Tool" |
| `[DATABASE]` | AI (from CONSTITUTION.md) | "PostgreSQL" |
| `[LIST_FIELDS]` | Human at use-time | "users.email, tokens.token_hash" |

---

## Tips

✅ **DO:**
- Use UUIDs for public-facing IDs
- Index foreign keys
- Use NOT NULL where appropriate
- Add CHECK constraints for validation
- Add comments explaining decisions

❌ **DON'T:**
- Over-normalize (too many joins)
- Forget indexes on foreign keys
- Use VARCHAR without length
- Store computed values
- Use reserved keywords

---

## Next Steps

1. Save to `database/migrations/[NNN]_[feature-name].sql`
2. Run in development database
3. Update ORM models (if using ORM)
4. Continue to implementation

---

## Related Resources

- [Solutions Architect Persona](../../personas/02-solutions-architect.md)
- [Database schema examples](../../examples/database-examples.md)
- Previous: [Tech Spec](./1.2-architect-tech-spec.md)
- Next: [API Design](./1.4-architect-api-design.md)
